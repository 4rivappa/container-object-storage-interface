---
# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: test-azure-key-retain
  labels:
    protocol: "Azure"
    authenticationType: "Key"
    deletionPolicy: "Retain"
spec:
  template: true
  steps:
  - name: Check if COSI Controller exist
    try:
    - assert:
        file: ../../../tests/controller.yaml
  - name: Create test BucketClass and BucketAccessClass
    try:
    - apply:
        file: ./resources/BucketClass.yaml
    - apply:
        file: ./resources/BucketAccessClass.yaml
  - name: Create BucketClaim
    try:
    - apply:
        file: ./resources/BucketClaim.yaml
  - name: Check if BucketClaim is ready
    try:
    - assert:
        resource:
          apiVersion: objectstorage.k8s.io/v1alpha1
          kind: BucketClaim
          metadata:
            name: test-azure-key-retain
          status:
            bucketReady: true
  - name: Create BucketAccess
    try:
    - apply:
        file: ./resources/BucketAccess.yaml
  - name: Check if BucketAccess is granted
    try:
    - assert:
        resource:
          apiVersion: objectstorage.k8s.io/v1alpha1
          kind: BucketAccess
          metadata:
            name: test-azure-key-retain
          status:
            accessGranted: true
  - name: Check if Secret exists
    try:
    - assert:
        resource:
          apiVersion: v1
          kind: Secret
          metadata:
            name: test-azure-key-retain
  - name: Run ObjectStorage validation tool
    # TODO: This should be either a standalone test tool developed by us, to run test suite:
    # - validate Secret format;
    # - validate connectivity to the Object Storage server;
    # Right now it is using busybox to check if the secret has correct format.
    try:
    - apply:
        file: ../../../tests/validator.yaml
    - create:
        resource:
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: test-azure-key-retain
          spec:
            ttlSecondsAfterFinished: 100
            template:
              spec:
                restartPolicy: Never
                containers:
                - name: secret-test
                  image: docker.io/library/python:3.12
                  command: [ "sh", "/validation/validation.sh" ]
                  volumeMounts:
                  - mountPath: /validator
                    name: validator
                  - mountPath: /conf
                    name: secret-vol
                volumes:
                - name: validator
                  configMap:
                    name: validator
                - name: secret-vol
                  secret:
                    secretName: test-azure-key-retain
                    items:
                    - key: BucketInfo
                      path: BucketInfo.json
  - name: Check if ObjectStorage validation tool completed succesfully
    try:
    - assert:
        resource:
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: test-azure-key-retain
          status:
            succeeded: 1
